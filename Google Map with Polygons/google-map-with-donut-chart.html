<!DOCTYPE html>
<html>
<head>
	<script type="text/javascript" src="https://www.google.com/jsapi"></script>
	<script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=false"></script>
	<script type="text/javascript" src="js/jquery-1.11.3.min.js"></script>
	<!-- states bounds -->
	<script type="text/javascript" src="./countries/USA/AK.geojson"></script>
	<script type="text/javascript" src="./countries/USA/AL.geojson"></script>
	<script type="text/javascript" src="./countries/USA/AR.geojson"></script>
	<script type="text/javascript" src="./countries/USA/AZ.geojson"></script>
	<script type="text/javascript" src="./countries/USA/CA.geojson"></script>
	<script type="text/javascript" src="./countries/USA/CO.geojson"></script>
	<script type="text/javascript" src="./countries/USA/CT.geojson"></script>
	<script type="text/javascript" src="./countries/USA/DC.geojson"></script>
	<script type="text/javascript" src="./countries/USA/DE.geojson"></script>
	<script type="text/javascript" src="./countries/USA/FL.geojson"></script>
	<script type="text/javascript" src="./countries/USA/GA.geojson"></script>
	<script type="text/javascript" src="./countries/USA/HI.geojson"></script>
	<script type="text/javascript" src="./countries/USA/IA.geojson"></script>
	<script type="text/javascript" src="./countries/USA/ID.geojson"></script>
	<script type="text/javascript" src="./countries/USA/IL.geojson"></script>
	<script type="text/javascript" src="./countries/USA/IN.geojson"></script>
	<script type="text/javascript" src="./countries/USA/KS.geojson"></script>
	<script type="text/javascript" src="./countries/USA/KY.geojson"></script>
	<script type="text/javascript" src="./countries/USA/LA.geojson"></script>
	<script type="text/javascript" src="./countries/USA/MA.geojson"></script>
	<script type="text/javascript" src="./countries/USA/MD.geojson"></script>
	<script type="text/javascript" src="./countries/USA/ME.geojson"></script>
	<script type="text/javascript" src="./countries/USA/MI.geojson"></script>
	<script type="text/javascript" src="./countries/USA/MN.geojson"></script>
	<script type="text/javascript" src="./countries/USA/MO.geojson"></script>
	<script type="text/javascript" src="./countries/USA/MS.geojson"></script>
	<script type="text/javascript" src="./countries/USA/MT.geojson"></script>
	<script type="text/javascript" src="./countries/USA/NC.geojson"></script>
	<script type="text/javascript" src="./countries/USA/ND.geojson"></script>
	<script type="text/javascript" src="./countries/USA/NE.geojson"></script>
	<script type="text/javascript" src="./countries/USA/NH.geojson"></script>
	<script type="text/javascript" src="./countries/USA/NJ.geojson"></script>
	<script type="text/javascript" src="./countries/USA/NM.geojson"></script>
	<script type="text/javascript" src="./countries/USA/NV.geojson"></script>
	<script type="text/javascript" src="./countries/USA/NY.geojson"></script>
	<script type="text/javascript" src="./countries/USA/OH.geojson"></script>
	<script type="text/javascript" src="./countries/USA/OK.geojson"></script>
	<script type="text/javascript" src="./countries/USA/OR.geojson"></script>
	<script type="text/javascript" src="./countries/USA/PA.geojson"></script>
	<script type="text/javascript" src="./countries/USA/PR.geojson"></script>
	<script type="text/javascript" src="./countries/USA/RI.geojson"></script>
	<script type="text/javascript" src="./countries/USA/SC.geojson"></script>
	<script type="text/javascript" src="./countries/USA/SD.geojson"></script>
	<script type="text/javascript" src="./countries/USA/TN.geojson"></script>
	<script type="text/javascript" src="./countries/USA/TX.geojson"></script>
	<script type="text/javascript" src="./countries/USA/UT.geojson"></script>
	<script type="text/javascript" src="./countries/USA/VA.geojson"></script>
	<script type="text/javascript" src="./countries/USA/VT.geojson"></script>
	<script type="text/javascript" src="./countries/USA/WA.geojson"></script>
	<script type="text/javascript" src="./countries/USA/WI.geojson"></script>
	<script type="text/javascript" src="./countries/USA/WV.geojson"></script>
	<script type="text/javascript" src="./countries/USA/WY.geojson"></script>
	<!-- parts of states -->

	<script type="text/javascript">
		google.load( 'visualization', '1', { packages:['corechart'] });

		var geoarray = {
			"country": "USA",
			"states" : [
				{"code": "AK", "data": AK, "center": new google.maps.LatLng(66, -151)},
				{"code": "AL", "data": AL, "center": new google.maps.LatLng(35, -89)},
				{"code": "AR", "data": AR, "center": new google.maps.LatLng(37, -96)},
				{"code": "AZ", "data": AZ, "center": new google.maps.LatLng(36, -114)},
				{"code": "CA", "data": CA, "center": new google.maps.LatLng(38, -121)},
				{"code": "CO", "data": CO, "center": new google.maps.LatLng(41, -109)},
				{"code": "CT", "data": CT, "center": new google.maps.LatLng(43, -77)},
				{"code": "DC", "data": DC, "center": new google.maps.LatLng(40, -79)},
				{"code": "DE", "data": DE, "center": new google.maps.LatLng(0,0)},
				{"code": "FL", "data": FL, "center": new google.maps.LatLng(0,0)},
				{"code": "GA", "data": GA, "center": new google.maps.LatLng(0,0)},
				{"code": "HI", "data": HI, "center": new google.maps.LatLng(0,0)},
				{"code": "ID", "data": ID, "center": new google.maps.LatLng(0,0)},
				{"code": "IL", "data": IL, "center": new google.maps.LatLng(0,0)},
				{"code": "IN", "data": IN}, {"code": "KS", "data": KS},
				{"code": "KY", "data": KY}, {"code": "LA", "data": LA}, {"code": "MA", "data": MA}, {"code": "MD", "data": MD},
				{"code": "ME", "data": ME}, {"code": "MI", "data": MI},	{"code": "MN", "data": MN},	{"code": "MO", "data": MO},
				{"code": "MS", "data": MS}, {"code": "MT", "data": MT}, {"code": "NC", "data": NC}, {"code": "ND", "data": ND},
				{"code": "NE", "data": NE}, {"code": "NH", "data": NH}, {"code": "NJ", "data": NJ}, {"code": "NM", "data": NM},
				{"code": "NV", "data": NV}, {"code": "NY", "data": NY}, {"code": "OH", "data": OH}, {"code": "OK", "data": OK},
				{"code": "OR", "data": OR}, {"code": "PA", "data": PA}, {"code": "PR", "data": PR}, {"code": "RI", "data": RI},
				{"code": "SC", "data": SC}, {"code": "SD", "data": SD}, {"code": "TN", "data": TN}, {"code": "TX", "data": TX},
				{"code": "UT", "data": UT}, {"code": "VA", "data": VA}, {"code": "VT", "data": VT}, {"code": "WA", "data": WA},
				{"code": "WI", "data": WI}, {"code": "WV", "data": WV}, {"code": "WY", "data": WY}
			]
		};

		var map;

		function DonutChartMarker( options ) {
			this.setValues( options );

			this.$inner = $('<div>').css({
				position: 'relative',
				//left: '-20%',
				//top: '-20%',
				width: options.width,
				height: options.height,
				fontSize: '1px',
				lineHeight: '1px',
				padding: '2px',
				backgroundColor: 'transparent',
				cursor: 'default'
			});

			this.$div = $('<div>')
					.append( this.$inner )
					.css({
						position: 'absolute',
						display: 'none'
					});
		};

		DonutChartMarker.prototype = new google.maps.OverlayView;

		DonutChartMarker.prototype.onAdd = function() {
			$( this.getPanes().overlayMouseTarget ).append( this.$div );
		};

		DonutChartMarker.prototype.onRemove = function() {
			this.$div.remove();
		};

		DonutChartMarker.prototype.draw = function() {
			var marker = this;
			var projection = this.getProjection();
			var position = projection.fromLatLngToDivPixel( this.get('position') );

			this.$div.css({
				left: position.x,
				top: position.y,
				display: 'block'
			})

			this.$inner
					.html( '<img src="' + this.get('image') + '"/>' )
					.click( function( event ) {
						var events = marker.get('events');
						events && events.click( event );
					});

			this.chart = new google.visualization.PieChart( this.$inner[0] );
			this.chart.draw( this.get('chartData'), this.get('chartOptions') );
		};

		function initialize() {
			var mapOptions = {
				center: {lat: 37, lng: -97},
				zoom: 4,
				disableDefaultUI: false,
				draggable: true,
				keyboardShortcuts: false,
				mapTypeId: google.maps.MapTypeId.NORMAL
			};
			map = new google.maps.Map($('#map-with-pie-chart')[0], mapOptions);

			var states = geoarray.states;

			for (var i = 0; i < states.length; i++) {
				map.data.addGeoJson(states[i].data);
			}

			map.data.setStyle(function(feature) {
				return {
					fillColor: 'transparent',
					strokeColor: '#FFFFFF',
					strokeWeight: 1.5
				};
			});

			map.data.addListener('mouseover', function(event) {
				var latitude = event.latLng.lat();
				var longitude = event.latLng.lng();
				document.getElementById('info-box').textContent = latitude + ', ' + longitude;
			});

			map.data.addListener('mouseout', function(event) {
				document.getElementById('info-box').textContent = 'Info box';
			});

			for (var i = 0; i < states.length; i++) {
				if (states[i].code == 'DE') {
					break;
				}
				var options = {
					legend: {position: 'none'},
					fontSize: 8,
					backgroundColor: 'transparent',
					pieHole: 0.4
					//title: states[i].code
				};
				var d = getRandomDonutData();
				var data = google.visualization.arrayToDataTable([
					[ 'Task', 'Hours per Day' ],
					[ 'Work', d[0] ],
					[ 'Eat', d[1] ],
					[ 'Commute', d[2] ],
					[ 'Watch TV', d[3] ],
					[ 'Sleep', d[4] ]
				]);
				var marker = new DonutChartMarker({
					map: map,
					position: states[i].center,
					width: '60px',
					height: '60px',
					chartData: data,
					chartOptions: options,
					events: {
						click: function( event ) {
							alert( 'Additional info' );
						}
					}
				});
			}
		}

		google.maps.event.addDomListener(window, 'load', initialize);

		function getRandomDonutData() {
			var result = [];
			var sleep = 24;
			for (var i = 0; i < 4; i++) {
				var value = Math.floor(Math.random()*4) + 2;
				result.push(value);
				sleep = sleep - value;
			}
			result.push(sleep);
			return result;
		}
	</script>
</head>
<body>
<table>
	<tr><td>
		<div id="map-with-pie-chart" style="width: 1200px; height: 800px;"></div>
	</td></tr>
	<tr><td>
		<div id="info-box" align='right'>Info box</div>
	</td></tr>
</table>
</body>
</html>